# .github/workflows/release-manager.yml
name: 'ğŸš€ Release Manager'

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish the release? (False = Create PR, True = Release Tag)'
        type: boolean
        required: true
        default: false
      prerelease-identifier:
        description: 'Prerelease identifier (e.g., alpha, rc.1). Leave empty for normal release.'
        required: false
        default: ''

  repository_dispatch:
    types: [upstream-updated]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-manager:
    name: Release Manager
    runs-on: ubuntu-latest
    # é‡è¦ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ª release ä»»åŠ¡åœ¨è¿è¡Œï¼Œé¿å…å†²çª
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0
          # ä½¿ç”¨ PAT ä»¥ä¾¿åç»­æ“ä½œï¼ˆå¦‚ push ä»£ç æˆ–è§¦å‘å…¶ä»–å·¥ä½œæµï¼‰èƒ½æ­£å¸¸å·¥ä½œ
          token: ${{ secrets.BOT_PAT }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Determine release parameters
        id: params
        shell: bash
        run: |
          PUBLISH=false
          PRERELEASE=false
          PRERELEASE_ID=""

          echo "ğŸ“‹ Event: ${{ github.event_name }}"

          case "${{ github.event_name }}" in
            workflow_dispatch)
              if [[ "${{ inputs.publish }}" == "true" ]]; then
                PUBLISH=true
                echo "   âœ“ Mode: RELEASE (Tag & Publish)"
              else
                echo "   âœ“ Mode: PREPARE (Create/Update PR)"
              fi

              if [[ -n "${{ inputs.prerelease-identifier }}" ]]; then
                PRERELEASE=true
                PRERELEASE_ID="${{ inputs.prerelease-identifier }}"
                echo "   âœ“ Prerelease Identifier: $PRERELEASE_ID"
              fi
              ;;

            repository_dispatch)
              # åªæœ‰ upstream-watcher è§¦å‘çš„äº‹ä»¶æ‰è‡ªåŠ¨å‘å¸ƒ
              TRIGGERED_BY="${{ github.event.client_payload.triggered_by }}"
              echo "   Repository dispatch from: $TRIGGERED_BY"
              if [[ "$TRIGGERED_BY" == "upstream-watcher" ]]; then
                PUBLISH=true
                echo "   âœ“ Upstream update detected, auto-publishing."
              fi
              ;;

            push)
               echo "   Standard push, updating Release PR only"
               ;; 
          esac

          # ç¡®å®šæœ€ç»ˆæ‰§è¡Œçš„ release-plz å­å‘½ä»¤
          if [[ "$PUBLISH" == "true" ]]; then
            COMMAND="release"
          else
            COMMAND="release-pr"
          fi

          # ç¡®å®š release type (prod / pre)
          # æ³¨æ„ï¼šå³ä½¿ inputs.prerelease-identifier ä¸ºç©ºï¼Œå¦‚æœç‰ˆæœ¬å·æœ¬èº«å¸¦åç¼€ï¼Œrelease-plz ä¹Ÿä¼šè¯†åˆ«ä¸º pre
          # è¿™é‡Œä¸»è¦ç”¨äºæ§åˆ¶ git_release_type å­—æ®µ
          if [[ "$PRERELEASE" == "true" ]]; then
            RELEASE_TYPE="pre"
          else
            RELEASE_TYPE="prod"
          fi

          {
            echo "publish=$PUBLISH"
            echo "prerelease=$PRERELEASE"
            echo "prerelease_id=$PRERELEASE_ID"
            echo "command=$COMMAND"
            echo "release_type=$RELEASE_TYPE"
          } >> "$GITHUB_OUTPUT"

      # å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœè¯•å›¾å‘å¸ƒ (Release)ï¼Œä½†å­˜åœ¨æœªåˆå¹¶çš„ release-plz PRï¼Œåˆ™ç¦æ­¢å‘å¸ƒ
      - name: Check for pending Release PRs
        if: steps.params.outputs.command == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Checking for pending release-plz PRs..."
          
          PENDING_PRS=$(gh pr list \
            --head "release-plz-" \
            --state open \
            --json number,title,url \
            --jq '.')

          PR_COUNT=$(echo "$PENDING_PRS" | jq 'length')

          if [[ "$PR_COUNT" -gt 0 ]]; then
            echo "âŒ ERROR: Cannot publish while Release PRs are still open!"
            echo "   Please review and merge the following PRs first:"
            echo "$PENDING_PRS" | jq -r '.[] | "   - [#\(.number)] \(.title) (\(.url))"'
            exit 1
          else
            echo "âœ… No pending Release PRs found. Proceeding..."
          fi

      # Prerelease é€»è¾‘ï¼šæ‰‹åŠ¨ä¿®æ”¹ Cargo.toml ç‰ˆæœ¬å·å¹¶æäº¤
      - name: Apply prerelease identifier
        if: steps.params.outputs.prerelease == 'true'
        run: |
          PRERELEASE_ID="${{ steps.params.outputs.prerelease_id }}"

          # ä» Cargo.toml è¯»å–å½“å‰ç‰ˆæœ¬
          # å‡è®¾æ ¼å¼: version = "0.1.0" æˆ– version = "0.1.0-alpha.1"
          CURRENT_VERSION=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\\1/')
          
          # ç§»é™¤ç°æœ‰çš„ prerelease åç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œè·å– Base Version
          BASE_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-.*//')

          # æ„å»ºæ–°ç‰ˆæœ¬å·: Base + æ–°çš„ Identifier
          NEW_VERSION="${BASE_VERSION}-${PRERELEASE_ID}"

          if [[ "$CURRENT_VERSION" == "$NEW_VERSION" ]]; then
             echo "â„¹ï¸ Version is already $NEW_VERSION, skipping update."
          else
             echo "ğŸ“¦ Updating version: ${CURRENT_VERSION} â†’ ${NEW_VERSION}"

             # æ›´æ–° Cargo.toml
             # ä½¿ç”¨ sed ä»…æ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„ version = ...
             sed -i "0,/^version = .*/s//version = \"${NEW_VERSION}\"/" Cargo.toml

             # æ›´æ–° Cargo.lock
             cargo update --workspace

             # æäº¤æ›´æ”¹
             git config user.name "github-actions[bot]"
             git config user.email "github-actions[bot]@users.noreply.github.com"
             git add Cargo.toml Cargo.lock
             git commit -m "chore(release): set prerelease version to ${NEW_VERSION}"
             
             # æ¨é€æ›´æ”¹ (ä½¿ç”¨ Checkout æ—¶é…ç½®çš„ PAT)
             git push
             
             echo "âœ… Prerelease version pushed."
          fi

      # åŠ¨æ€ç”Ÿæˆæœ€ç»ˆé…ç½®æ–‡ä»¶
      - name: Generate dynamic config
        run: |
          RELEASE_TYPE="${{ steps.params.outputs.release_type }}"
          
          echo "ğŸ”§ Generating release-plz-dynamic.toml based on release-plz.toml..."
          
          # å¤åˆ¶åŸºç¡€é…ç½®
          cp release-plz.toml release-plz-dynamic.toml
          
          # è¿½åŠ åŠ¨æ€é…ç½®
          # è¿™é‡Œæˆ‘ä»¬è¿½åŠ åˆ° [workspace] éƒ¨åˆ†ä¸‹é¢ã€‚
          # ç”±äº TOML çš„ç»“æ„ï¼Œç›´æ¥è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾å¯èƒ½ä¼šç ´å [changelog] ç­‰ section çš„å½’å±ã€‚
          # æœ€å®‰å…¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ sed åœ¨ [workspace] ä¹‹åæ’å…¥ï¼Œæˆ–è€…å¦‚æœæ–‡ä»¶å¼€å¤´å°±æ˜¯ workspaceï¼Œç›´æ¥æ’å…¥å¤´éƒ¨ã€‚
          # release-plz.toml å¼€å¤´å°±æ˜¯ [workspace]ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿½åŠ åœ¨ç¬¬ä¸€è¡Œåé¢å³å¯ï¼Œæˆ–è€…ç›´æ¥ç”¨ sed æ›¿æ¢å ä½ç¬¦ï¼ˆå¦‚æœç”¨æ¨¡æ¿çš„è¯ï¼‰ã€‚
          # ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥è¿½åŠ åˆ°æ–‡ä»¶å¤´éƒ¨ï¼ˆTOML å…è®¸é‡å¤ key å—ï¼Ÿé€šå¸¸ä¸å…è®¸ï¼Œä½†ä¸åŒ section å¯ä»¥ï¼‰ã€‚
          # æ›´å¥½çš„æ–¹å¼ï¼šrelease-plz.toml é‡Œä¸å†™è¿™å‡ ä¸ªåŠ¨æ€ keyï¼Œæˆ‘ä»¬è¿™é‡Œè¿½åŠ ã€‚
          # ç”±äº release-plz.toml æ˜¯æˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ï¼Œæˆ‘ä»¬ç¡®ä¿ [workspace] åœ¨æœ€å‰é¢ã€‚
          # æˆ‘ä»¬å¯ä»¥ç”¨ sed åœ¨ [workspace] è¿™ä¸€è¡Œä¸‹é¢æ’å…¥åŠ¨æ€é…ç½®ã€‚

          sed -i "/^\\\[workspace\\\\]/a git_release_type = \"${RELEASE_TYPE}\"" release-plz-dynamic.toml
          
          echo "ğŸ“„ Dynamic Config Preview (Top 20 lines):"
          head -n 20 release-plz-dynamic.toml

      - name: Run release-plz
        uses: release-plz/action@v0.5  # 7301a1468f3100413e5c49cf300358beaada1bf3  # v0.3.149
        with:
          command: ${{ steps.params.outputs.command }}
          config: release-plz-dynamic.toml
        env:
          # å¿…é¡»ä½¿ç”¨ PAT æ‰èƒ½è§¦å‘åç»­çš„ CI å·¥ä½œæµ
          GITHUB_TOKEN: ${{ steps.params.outputs.publish == 'true' && secrets.BOT_PAT || secrets.GITHUB_TOKEN }}

